{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Inicio de Detección</title>
    <link rel="stylesheet" href="{% static 'css/deteccion.css' %}">
</head>
<body>
    <a href="{% url 'niño:juegos_recomendados' %}">IA</a>
    <div class="container">
        <h1>🧠 Detección de Somnolencia y Distracción</h1>
        <p>La detección ha comenzado automáticamente.</p>

        <p id="espera">⏳ Esperando resultados...</p>
        <button id="btnFinalizar" onclick="finalizar()">Finalizar detección</button>

        <div id="resultados" class="result-box" style="display: none;">
            <h2>📊 Resultados:</h2>
            <p><strong>😴 Somnolencias:</strong> <span id="s_count"></span></p>
            <p><strong>⏱️ Tiempos (s):</strong> <span id="s_tiempos"></span></p>
            <p><strong>🙈 Distracciones:</strong> <span id="d_count"></span></p>
            <p><strong>⏱️ Tiempos (s):</strong> <span id="d_tiempos"></span></p>
            <p><strong>🕒 Duración total (s):</strong> <span id="duracion"></span></p>
        </div>
    </div>

    <script>
    function finalizar() {
        const btn = document.getElementById("btnFinalizar");
        btn.disabled = true;
        document.getElementById("espera").innerText = "⏳ Finalizando detección...";

        fetch("{% url 'niño:ia_fin' %}")
        .then(res => {
            if (!res.ok) {
                throw new Error("Respuesta del servidor inválida: " + res.status);
            }
            return res.json();
        })
        .then(data => {
            document.getElementById("espera").style.display = "none";
            document.getElementById("resultados").style.display = "block";

            document.getElementById("s_count").innerText = data.somnolencias ?? 0;
            document.getElementById("s_tiempos").innerText = data.tiempos_somnolencia?.join(', ') || "N/A";
            document.getElementById("d_count").innerText = data.distracciones ?? 0;
            document.getElementById("d_tiempos").innerText = data.tiempos_distraccion?.join(', ') || "N/A";
            document.getElementById("duracion").innerText = data.duracion_total ?? 0;
        })
        .catch(err => {
            console.error("⚠️ Error:", err);
            document.getElementById("espera").innerText = "❌ Error al obtener resultados.";
            alert("Ocurrió un error: " + err.message);
            btn.disabled = false; // Permitir reintento
        });
    }
    </script>
</body>
</html>
